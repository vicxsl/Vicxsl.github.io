---
title: ZooKeeper
article: false
date: 2021-11-11 18:55:16
pageClass: custom-page-class
permalink: /pages/7d73c3/
---
# ZooKeeper

```markmap
# ZooKeeper
* `一个开源的分布式协调服务，为分布式应用提供一致性服务`
* 分布式一致性的概念
    - 顺序一致性
        - 通过zxid保证全局有序
    - 原子性
    - 单一视图
    - 可靠性
    - 实时性（最终一致性）
- 主要功能
    - 文件系统
        - 多层级的节点命名空间
        - 节点称为znode
            - PERSISTENT-持久节点
            - EPHEMERAL-临时节点
            - PERSISTENT_SEQUENTIAL-持久顺序节点
            - EPHEMERAL_SEQUENTIAL-临时顺序节点_
        - 维护在内存中
            - 保证高吞吐和低延迟
            - 不能存放大量的数据
    - 通知机制
        - 原子广播机制
            - 恢复模式
            - 广播模式
        - Watcher 机制
            -  Watcher 监听
                - 出现指定事件
                - 发送事件通知
                - 客户端根据Watcher通知状态和事件类型响应
            - 工作机制：
                * 客户端注册 watcher
                * 服务端处理 watcher
                * 客户端回调 watcher
            - 实现
                - 客户端注册Watcher 实现
                - 服务端处理 Watcher 实现
                - 客户端回调 Watcher
        -
- 服务器角色
    - Leader`领导者状态`
        - 事务请求的唯一调度和处理者，保证集群事务处理的顺序性
        - 集群内部各服务的调度者
    - Follower`跟随者状态`
        - 处理客户端的非事务请求，转发事务请求给 Leader 服务器
        - 参与事务请求 Proposal 的投票
        - 参与 Leader 选举投票
    - Observer`观察者状态`
        - 3.0 版本以后引入的一个服务器角色，在不影响集群事务处理能力的基础上提升集群的非事务处理能力
        - 处理客户端的非事务请求，转发事务请求给 Leader 服务器
        - 不参与任何形式的投票
- 应用场景
    - 数据发布/订阅
        - 动态获取配置
        - 特点
            - 数据量小
            - 数据内容在运行时会动态更新
            - 集群所有机器共享，配置一致
        - 实现
            - 数据存储
            - 数据获取，创建Watcher
            - 数据变更，通知客户端
    - 负载均衡
    - 命名服务
        - 创建全局路径
        - 指向服务的地址，远程对象
    - 分布式协调/通知
        - 改变节点状态
        - 通知注册了节点watcher的客户端
    - 集群管理
        - 创建临时目录节点
        - 机器挂掉，其创建的临时节点删除
        - 某个兄弟目录被删除
    - Master选举
    - 分布式锁
        - 保持独占
            - znode看作一把锁
            - createznode的方式来实现
            - 所有客户端创建 /distribute_lock 节点_
            - 成功创建的拥有锁
            - 删除distribute_lock  节点就释放锁_
        - 控制时序
            - 创建临时顺序目录节点
                - 编号最小的获得锁
                - 用完删除
    - 分布式队列
- 重点
    - 如何保证顺序一致性
        - 全局递增的事务 Id
        - zxid 实际上是一个 64 位的数字
    - 分布式集群为什么会有Master主节点
        - 某些业务逻辑只需要集群的某一台机器执行
        - 其余机器共享结果
        - 减少重复计算，提高性能
    - zk节点宕机如何处理
        - 推荐配置不少于3个服务器
        -  Follower 宕机，还有 2 台服务器提供访问
        - Leader 宕机，Zookeeper 会选举出新的 Leader
        - 超过半数的节点正常，集群可以正常提高服务
```